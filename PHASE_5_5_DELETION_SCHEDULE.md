# Phase 5-5 v1 API 完全削除スケジュール

**開始日**: 2025-02-07
**終了日**: 2025-03-17 (6 週間)
**目標**: API v1 エンドポイント完全削除＆v2 への統一
**成功指標**: v1 トラフィック 0%, 全 v2 エンドポイント 100% 稼働, クライアント 100% 移行

---

## 📋 概要

Phase 5-4 で Deprecation ヘッダーを導入し、クライアントに v1 削除予定を通知しました。
Phase 5-5 では、実際に v1 エンドポイントをコードベースから削除し、v2 を唯一のメインラインとします。

### フェーズの進行方針

1. **Week 1-2 (2025-02-07 ~ 2025-02-20)**: 最終クライアント支援 & 移行確認
2. **Week 3-4 (2025-02-21 ~ 2025-03-06)**: v1 コード削除準備
3. **Week 5-6 (2025-03-07 ~ 2025-03-17)**: v1 削除実行＆本番投入

---

## 🗓️ 詳細スケジュール

### Phase 5-4 との移行期間 (2025-02-07 ~ 2025-02-20): 最終支援と移行確認

#### Week 1 (2025-02-07 ~ 2025-02-13): 段階的トラフィック監視と支援

**ゴール**:

- v1 トラフィック < 50% に低下確認
- 問題報告クライアント全て対応
- v2 安定稼働確認

**タスク**:

| タスク | 時間 | 内容 |
|-------|------|------|
| **Grafana 監視強化** | 4h | v1/v2 アクセス比率をリアルタイム表示。ダッシュボード確認頻度を 1h ごとに設定 |
| **クライアント対応窓口** | 8h | Slack #api-support で常駐サポート。移行の詰まりを解決 |
| **v2 パフォーマンステスト** | 4h | 高負荷環境（1000 req/s）でテスト。エラー率 < 0.1% を確認 |
| **v1 キャッシュ無効化確認** | 2h | レガシークライアント向けキャッシュが正しく機能しているか検証 |

**成果物**:

- Grafana ダッシュボード（更新）
- クライアント対応ログ（issue トラッキング）
- パフォーマンステストレポート

**進捗目標**: v1 トラフィック 40-50% に低下

---

#### Week 2 (2025-02-14 ~ 2025-02-20): 段階的削除計画の最終確認

**ゴール**:

- 全クライアント移行完了確認（またはサポート期間延長判断）
- v1 削除に向けた最終チェックリスト実行
- 本番前ドライラン実施

**タスク**:

| タスク | 時間 | 内容 |
|-------|------|------|
| **最終クライアント調査** | 4h | v1 利用中のクライアント全て特定。未移行理由をヒアリング |
| **v1 削除プレテスト** | 6h | ステージング環境で v1 エンドポイント削除後のテスト実行 |
| **フォールバック計画作成** | 3h | 問題発生時の復旧手順文書化 |
| **Slack/Blog 最終通知** | 2h | v1 削除まで 4 週間という警告通知送信 |

**成果物**:

- クライアント移行状況レポート（100% or 例外リスト）
- v1 削除ドライラン結果
- フォールバック計画書

**進捗目標**: v1 トラフィック 30% 以下に低下、クライアント移行 95%+

---

### v1 削除準備フェーズ (2025-02-21 ~ 2025-03-06): コード整理と最適化

#### Week 3 (2025-02-21 ~ 2025-02-27): v1 ハンドラー依存関係の分析

**ゴール**:

- v1 コード削除の正確な影響範囲を特定
- 共有ロジック（DB クエリ等）の v2 への移行準備
- 最終テストスイート作成

**タスク**:

| タスク | 時間 | 内容 |
|-------|------|------|
| **v1 ハンドラー依存分析** | 8h | `src/handlers/` の v1 実装が使用している共有ロジックを全て特定。脆弱性スキャン |
| **v2 コード品質監査** | 6h | v1 削除後に v2 が正しく動作するか静的解析。Clippy 警告ゼロ化 |
| **削除対象ファイル一覧作成** | 4h | 以下ファイルの完全なリストを作成：<br>- `src/handlers/v1/` (すべてのファイル)<br>- 古いリポジトリ実装<br>- 非推奨ユーティリティ |
| **最終テストスイート作成** | 8h | v1 削除後に v2 が 100% カバーしていることを確認するテスト。50+ エンドポイントテスト |

**成果物**:

- 依存関係分析レポート（Markdown）
- 削除対象ファイル一覧（CSV）
- テストスイート

**進捗目標**: 削除計画 100% 明確化、テスト 100% 作成完了

---

#### Week 4 (2025-02-28 ~ 2025-03-06): v1 削除実行（ステージング環境）

**ゴール**:

- ステージング環境で v1 完全削除テスト
- 本番適用前の最終検証

**タスク**:

| タスク | 時間 | 内容 |
|-------|------|------|
| **v1 ハンドラー削除** | 4h | `src/handlers/v1/` 削除（ステージング環境）。ファイル削除、import 文削除 |
| **v1 ルーティング削除** | 2h | `routes.rs` から `/api/v1` ルート定義を削除 |
| **v1 テスト削除** | 4h | `tests/v1_*.rs` 削除。v2 テストのみ残存確認 |
| **Cargo.toml v1 feature 削除** | 1h | v1 feature flag 削除（もし存在する場合） |
| **ステージング E2E テスト** | 6h | v2 50+ エンドポイント全て稼働確認。本番前最終テスト |
| **パフォーマンステスト（再実行）** | 4h | v1 コード削除後のパフォーマンスが改善されたか確認（< 5% 改善期待） |

**成果物**:

- v1 削除完了確認ファイル一覧
- ステージング E2E テストレポート
- 本番前パフォーマンス指標

**進捗目標**: ステージング環境での v1 削除完全検証

---

### v1 完全削除と本番投入 (2025-03-07 ~ 2025-03-17): 最終削除と安定化

#### Week 5 (2025-03-07 ~ 2025-03-13): 本番環境への v1 削除適用

**ゴール**:

- 本番環境での v1 完全削除
- 中止機能削除後のメトリクス監視開始

**タスク**:

| タスク | 時間 | 内容 |
|-------|------|------|
| **GitHub ブランチ作成** | 0.5h | `release/v3.0.0-no-v1` ブランチ作成 |
| **本番コード変更適用** | 4h | main ブランチに v1 削除変更をマージ（テスト、Clippy 通過後） |
| **本番ビルド & テスト** | 4h | 本番環境 CI/CD パス確認。すべてのテスト実行 |
| **段階的ロールアウト開始** | 2h | Canary デプロイ（10% トラフィック）開始 |
| **Monitoring 強化** | 4h | エラー率 < 0.05% を確認。アラート設定調整 |

**成果物**:

- v1 削除適用完了ログ
- 本番 CI/CD テスト結果
- 初期モニタリング指標

**進捗目標**: 本番環境段階的デプロイ開始

---

#### Week 5 後半-6 (2025-03-14 ~ 2025-03-17): 段階的トラフィック切り替えと最終安定化

**ゴール**:

- 本番環境を 100% v2 へ切り替え完了
- 予期しない問題ゼロ確認
- サービス完全安定化

**タスク**:

| タスク | 時間 | 内容 |
|-------|------|------|
| **段階的ロールアウト Day 1-2** (3月14-15) | 4h | 10% → 25% → 50% トラフィック段階的切り替え。エラー率監視 |
| **段階的ロールアウト Day 3-4** (3月16-17) | 4h | 50% → 100% 切り替え完了。全トラフィック v2 のみ運用 |
| **最終メトリクス検証** | 2h | v2 エラー率 < 0.05%、レスポンスタイム < 50ms 確認 |
| **v1 削除完了の正式発表** | 1h | ブログ・Slack で v1 完全削除と v2 移行完了を発表 |
| **ドキュメント更新** | 2h | README/API ドキュメントから v1 記述削除、v2 のみ記載 |

**成果物**:

- ロールアウト完了ログ
- 最終メトリクスレポート
- 公式アナウンス
- 更新ドキュメント

**進捗目標**: v1 完全削除完了、v2 100% 本番運用

---

## 📊 削除対象ファイル・モジュール一覧

### 削除する src/ ファイル

```
src/handlers/v1/                      # すべて削除
├── users.rs
├── posts.rs
├── comments.rs
├── tags.rs
├── categories.rs
├── search.rs
├── analytics.rs
├── auth.rs
└── admin.rs

src/repositories/legacy/              # 古いリポジトリ実装（削除）
├── postgres.rs
├── cache_layer.rs
└── search_adapter.rs

src/routes/v1.rs                      # v1 ルーティング（削除）
```

### 削除する tests/ ファイル

```
tests/v1_*.rs                         # すべてのv1テスト
├── v1_users_test.rs
├── v1_posts_test.rs
├── v1_comments_test.rs
├── v1_pagination_test.rs
├── v1_error_formats_test.rs
└── v1_deprecation_headers_test.rs
```

### 保持する src/ ファイル

```
src/handlers/v2/                      # v2 ハンドラー（保持・拡張）
src/application/                      # アプリケーション層（保持）
src/domain/                           # ドメイン層（保持）
src/infrastructure/                   # インフラ層（保持）
```

---

## ✅ v1 削除チェックリスト

### コード削除フェーズ

- [ ] `src/handlers/v1/` 配下すべてのファイル削除
- [ ] `src/routes/v1.rs` 削除
- [ ] `src/handlers/mod.rs` から v1 import 削除
- [ ] `src/routes/mod.rs` から v1 import 削除
- [ ] `src/main.rs` から v1 ルーティング初期化削除
- [ ] `Cargo.toml` から v1 feature flag 削除（もし存在）

### テスト削除フェーズ

- [ ] `tests/v1_*.rs` すべて削除
- [ ] `tests/integration/v1/` 配下削除
- [ ] `src/handlers/v1/` に対応するユニットテスト削除

### コンパイル & テストフェーズ

- [ ] `cargo build --all-features` 成功
- [ ] `cargo clippy --all-targets --all-features -- -D warnings` 警告ゼロ
- [ ] `cargo test --workspace` v2 テスト 100% 成功
- [ ] `cargo fmt --check` フォーマット OK

### ドキュメント更新フェーズ

- [ ] `README.md` から v1 記述削除
- [ ] `docs/API.md` から v1 エンドポイント削除
- [ ] `docs/API_V1_TO_V2_MIGRATION_GUIDE.md` をアーカイブ化
- [ ] `CHANGELOG.md` に v3.0.0 リリースノート追加

### Git & リリースフェーズ

- [ ] `git commit -m "🗑️ Phase 5-5: Remove v1 API endpoints (v3.0.0)"`
- [ ] `git tag -a v3.0.0 -m "v1 API Removed - v2 Only"`
- [ ] GitHub Release ノート作成（移行ガイド最終版リンク含む）
- [ ] npm / Docker 等での v3.0.0 リリース

---

## 🚨 フォールバック計画

### 問題検出時の対応（< 2h で判定）

#### パターン 1: v2 エラー率異常 (> 1%)

**対応**:

1. v1 ブランチから緊急ロールバック
2. 問題原因特定（v1 削除時の migration マイグレーション忘れなど）
3. ホットフィックス実行

```bash
# ロールバック（5分以内）
git revert <v1-deletion-commit>
git push origin main
# CI/CD で自動デプロイ
```

#### パターン 2: 予期しないクライアント側エラー

**対応**:

1. 詳細なエラーログ取得
2. クライアント側対応計画立案（最大 48h）
3. 必要に応じて v1 一時復旧（最大 1 週間）

#### パターン 3: データ不整合検出

**対応**:

1. 本番一時停止
2. DB レプリケーション確認
3. 不整合レコード修復（アプリケーションロジック層）

---

## 📈 成功指標

### Week 1-2（支援期間）

| 指標 | 目標 | 実績 |
|------|------|------|
| v1 トラフィック | < 30% | \_\_\_\_\_ |
| クライアント移行 | > 90% | \_\_\_\_\_ |
| v2 エラー率 | < 0.1% | \_\_\_\_\_ |
| 支援チケット | < 10件 | \_\_\_\_\_ |

### Week 3-4（削除準備）

| 指標 | 目標 | 実績 |
|------|------|------|
| テストカバレッジ | 100% | \_\_\_\_\_ |
| ドライラン成功 | 100% | \_\_\_\_\_ |
| Clippy 警告 | 0 | \_\_\_\_\_ |
| コード削除完全性 | 100% | \_\_\_\_\_ |

### Week 5-6（本番投入）

| 指標 | 目標 | 実績 |
|------|------|------|
| ロールアウト成功 | 100% | \_\_\_\_\_ |
| v2 エラー率 | < 0.05% | \_\_\_\_\_ |
| ロールバック回数 | 0 | \_\_\_\_\_ |
| クライアント満足度 | > 95% | \_\_\_\_\_ |

---

## 📝 関連ドキュメント

- `PHASE_5_4_DETAILED_SCHEDULE.md` — Deprecation ヘッダー実装スケジュール
- `docs/API_V1_TO_V2_MIGRATION_GUIDE.md` — クライアント移行ガイド
- `ROLLBACK_PLAN.md` — ロールバック手順詳細
- `TESTING_STRATEGY.md` — テスト戦略（v2 検証用）

---

**作成日**: 2025-01-17 (Phase 5-4 準備セッション)
**更新予定**: 2025-02-07 (Phase 5-5 開始)
**ステータス**: 計画立案完了、実装準備中
