# コメント記法ガイド（RustCMS）

目的: リポジトリ全体で一貫した日本語ドキュメンテーションと読みやすいソースコメントを維持する。

## 基本方針

- 公開API（pub の型/関数/モジュール）には Rustdoc を必ず付与。
- 内部実装の意図・注意点・落とし穴はインラインコメントで補足。
- 変更しやすさを優先し、仕様・契約・副作用を明確にする。

## 記法の使い分け

- モジュール先頭: `//!` でモジュール全体の概要・責務・外部依存・feature 影響を説明。
- 型/関数/定数: `///` で概要→契約（入力/出力/エラー/副作用/前提条件）→例（任意）。
- インライン補足: `//` でアルゴリズムの意図・非自明な分岐・注意点を一行～数行で。

## 関数コメントテンプレ（契約）

```rust
/// 概要: 何をする関数か（1～3行）
///
/// 入力:
/// - param_a: 役割や単位、制約
/// - param_b: 役割や単位、制約
///
/// 返り値:
/// - Ok(T): 正常系の意味
/// - Err(AppError::Xxx): 主な失敗理由
///
/// エラー:
/// - Validation: 入力検証エラー
/// - Database: DB接続や一貫性エラー
///
/// 副作用:
/// - DB 書き込み / キャッシュ無効化 / 外部IO
///
/// 前提条件:
/// - 呼び出し前に認可済みであること 等
```

## 用語と表記

- 用語は `docs/GLOSSARY_JA.md` の対訳に従う。
- 英語固有名詞（例: Biscuit, WebAuthn）はそのまま表記、必要に応じて日本語補足。

## Feature フラグの明示

- `#[cfg(feature = "...")]` の意味（有効時の挙動差・互換性）をコメントに明記。
- 互換性維持の暫定 feature は、削除予定（バージョン）を併記。

## エンドポイント（ハンドラ）記述指針

- 目的 / 入力（パス/クエリ/ボディ） / 出力（HTTPコード/スキーマ） / 認可 / レート制限 / 副作用 / エラー。
- 例（リクエスト/レスポンス）を簡潔に示す。

## ドキュメント生成

- `cargo doc --all-features` で警告が出ないことを目標。
- `openapi.rs` の説明は utoipa のスキーマと整合。

## よくある落とし穴

- ログやメトリクスの初期化順序の誤り → `telemetry.rs` の指針に従う。
- 非同期ランタイムのブロッキング呼び出し → `tokio::task::spawn_blocking` を検討。
- feature の不整合 → Cargo.toml の features 節を参照。
